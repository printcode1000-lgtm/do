<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>صفحة الموضوعات</title>
    <style>
      body {
        font-family: "Tahoma", "Segoe UI", sans-serif;
        background-color: #f0f2f5;
        color: #1c1e21;
        margin: 0;
        padding-top: 60px; /* لإعطاء مساحة لشريط التنقل الثابت */
      }
      .container {
        background-color: #ffffff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
        width: 95%;
        max-width: 1200px;
        min-height: calc(100vh - 80px);
        margin: 0 auto 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      h1 {
        text-align: center;
        color: #0056b3;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
      }
      label {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 8px;
        display: block;
      }
      select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccd0d5;
        font-size: 1em;
        box-sizing: border-box;
        transition: border-color 0.2s;
        margin-bottom: 20px;
      }
      select:focus {
        border-color: #0056b3;
        outline: none;
      }
      /* شريط التنقل العلوي */
      .top-nav {
        background-color: #343a40;
        padding: 10px 0;
        text-align: center;
        position: fixed; /* أو sticky */
        top: 0;
        right: 0;
        left: 0;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .top-nav a.nav-button {
        color: white;
        padding: 8px 20px;
        border-radius: 5px;
        text-decoration: none;
        margin: 0 10px;
        font-weight: bold;
      }
      /* أنماط إضافية */
      textarea {
        width: 100%;
        min-height: 300px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccd0d5;
        font-size: 1em;
        box-sizing: border-box;
        resize: vertical;
        margin-top: 15px;
        line-height: 1.6;
      }
      /* حاوية المحرر الجديدة */
      .editor-wrapper {
        position: relative;
        margin-top: 15px;
        width: 100%;
        min-height: 300px;
        font-size: 1em;
        line-height: 1.6;
      }
      .editor-wrapper > textarea,
      .editor-wrapper > #highlighter {
        margin: 0;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccd0d5;
        font: inherit;
        letter-spacing: inherit;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        min-height: 300px;
        box-sizing: border-box;
        white-space: pre-wrap;
        word-wrap: break-word;
        resize: none; /* يتم التحكم به من خلال textarea */
      }
      .editor-wrapper > textarea {
        z-index: 1;
        background-color: transparent;
        color: inherit;
        pointer-events: none; /* السماح للنقرات بالمرور إلى الطبقة السفلية بشكل افتراضي */
      }
      .editor-wrapper > #highlighter {
        z-index: 0;
        color: transparent; /* النص الأساسي يكون شفافًا */
      }
      .editor-wrapper #highlighter .date-highlight {
        background-color: #fffbdd; /* لون تمييز التاريخ - أصفر فاتح */
        color: inherit; /* استخدام لون النص الأصلي */
        border-radius: 3px;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .button {
        padding: 10px 15px;
        font-size: 1em;
        font-weight: bold;
        color: white;
        background-color: #0056b3;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .button:hover {
        background-color: #004494;
      }
      #save-status {
        text-align: center;
        color: #28a745;
        font-weight: bold;
        margin-bottom: 10px;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
    </style>
  </head>
  <body>
    <nav class="top-nav">
      <a href="index.html" class="nav-button button">الرئيسية</a>
      <a href="topics.html" class="nav-button button">الموضوعات</a>
      <a href="search.html" class="nav-button button">بحث</a>
    </nav>
    <div class="container">
      <h1>الموضوعات</h1>
      <p id="save-status"></p>

      <div class="button-group">
        <button id="load-data-btn" class="button">تحميل و حفظ</button>
        <button id="export-data-btn" class="button">تصدير</button>
      </div>

      <div>
        <label for="topic-selector">اختر موضوعًا:</label>
        <select id="topic-selector">
          <!-- سيتم ملء الخيارات بواسطة جافاسكريبت -->
        </select>
      </div>
      <div id="content-area">
        <!-- سيتم عرض منطقة الكتابة هنا -->
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const topicSelector = document.getElementById("topic-selector");
        const contentArea = document.getElementById("content-area");
        const loadButton = document.getElementById("load-data-btn");
        const exportButton = document.getElementById("export-data-btn");
        const saveStatus = document.getElementById("save-status");

        const dbName = "EventsDB";
        const storeName = "topicsContent";
        let autoSaveTimer = null;

        // قائمة الموضوعات مع معرفات فريدة
        // تم تصحيح المعرفات المكررة
        const topicsList = [
          { id: "1", name: "مسؤوليه المهندس المشرف" },
          { id: "2", name: "الحيادية والعدل" },
          { id: "3", name: "محضر تسليم موقع" },
          { id: "4", name: "الكيد لي لالحاق الضرر" },
          { id: "5", name: "طلبات ومراسلات" },
          { id: "6", name: "موضوع عام" },
        ];

        function openDB() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 2); // زيادة رقم الإصدار

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains("events")) {
                db.createObjectStore("events", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              }
              if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: "id" });
              }
            };

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
          });
        }

        async function getTopicContent(topicId) {
          const db = await openDB();
          const transaction = db.transaction(storeName, "readonly");
          const store = transaction.objectStore(storeName);
          const request = store.get(topicId);

          return new Promise((resolve) => {
            request.onsuccess = () => {
              resolve(request.result ? request.result.content : "");
            };
            request.onerror = () => resolve("");
          });
        }

        async function saveTopicContent(topicId, content) {
          const db = await openDB();
          const transaction = db.transaction(storeName, "readwrite");
          const store = transaction.objectStore(storeName);
          store.put({ id: topicId, content: content });

          return new Promise((resolve, reject) => {
            transaction.oncomplete = () => {
              showSaveStatus();
              resolve();
            };
            transaction.onerror = (event) => reject(event.target.error);
          });
        }

        async function importData(data) {
          const db = await openDB();
          const transaction = db.transaction(storeName, "readwrite");
          const store = transaction.objectStore(storeName);
          store.clear(); // مسح البيانات القديمة
          data.forEach((item) => store.add(item));
          return new Promise((resolve, reject) => {
            transaction.oncomplete = resolve;
            transaction.onerror = (e) => reject(e.target.error);
          });
        }

        async function exportData() {
          const db = await openDB();
          const transaction = db.transaction(storeName, "readonly");
          const store = transaction.objectStore(storeName);
          const request = store.getAll();

          return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
          });
        }

        // دالة للبحث عن الحدث حسب التاريخ مع مراعاة التنسيقات المختلفة
        async function findEventByDate(dateString) {
          const db = await openDB();
          const transaction = db.transaction("events", "readonly");
          const store = transaction.objectStore("events");
          const request = store.getAll();

          // دالة لتطبيع صيغة التاريخ (إزالة الأصفار البادئة)
          const normalizeDate = (ds) => {
            if (!ds) return ""; // حماية ضد التواريخ الفارغة
            const parts = ds.split("-");
            if (parts.length !== 3) return ds;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            return `${day}-${month}-${year}`;
          };

          return new Promise((resolve, reject) => {
            request.onsuccess = () => {
              console.log("[تتبع] تم جلب جميع الأحداث من قاعدة البيانات.");
              const allEvents = request.result;
              const normalizedDateToFind = normalizeDate(dateString);
              console.log(
                `[تتبع] البحث عن التاريخ بعد التنسيق: "${normalizedDateToFind}"`
              );

              const foundEvent = allEvents.find(
                (event) => normalizeDate(event.date) === normalizedDateToFind
              );

              console.log("[تتبع] نتيجة البحث:", foundEvent);
              resolve(foundEvent); // سيكون undefined إذا لم يتم العثور عليه
            };
            request.onerror = (e) =>
              reject(
                console.error(
                  "[تتبع] خطأ في قراءة قاعدة البيانات:",
                  e.target.error
                )
              );
          });
        }

        loadButton.addEventListener("click", async () => {
          try {
            const response = await fetch("topics_data.json");
            if (response.ok) {
              const fileData = await response.json();
              await importData(fileData);
              alert("تم تحميل وحفظ البيانات بنجاح.");
              // إعادة تحميل المحتوى إذا كان هناك موضوع محدد
              if (topicSelector.value) {
                topicSelector.dispatchEvent(new Event("change"));
              }
            } else if (response.status === 404) {
              // إذا لم يتم العثور على الملف، قم بإنشاء بيانات فارغة
              await initializeEmptyData();
              alert(
                "لم يتم العثور على ملف بيانات، تم إنشاء بيانات أولية فارغة."
              );
            } else {
              alert(
                "ملف 'topics_data.json' غير موجود أو لا يمكن الوصول إليه. يمكنك إنشاء بيانات جديدة وتصديرها لاحقًا."
              );
            }
          } catch (error) {
            console.error("Error loading or saving data:", error);
            alert("فشل تحميل أو حفظ البيانات. قد يكون الملف غير موجود.");
          }
        });

        exportButton.addEventListener("click", async () => {
          try {
            const dataToExport = await exportData();
            if (!dataToExport || dataToExport.length === 0) {
              alert("لا توجد بيانات لتصديرها.");
              return;
            }

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });

            // استخدام File System Access API الحديثة (مثل الصفحة الرئيسية)
            if (window.showSaveFilePicker) {
              try {
                const handle = await window.showSaveFilePicker({
                  suggestedName: "topics_data.json",
                  types: [
                    {
                      description: "JSON Files",
                      accept: { "application/json": [".json"] },
                    },
                  ],
                });
                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                alert("تم حفظ الملف بنجاح.");
              } catch (err) {
                if (err.name !== "AbortError") {
                  console.error("Error saving file:", err);
                  alert("فشل حفظ الملف.");
                }
              }
            } else {
              // الطريقة البديلة للمتصفحات الأخرى
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "topics_data.json";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }
          } catch (error) {
            console.error("Error exporting data:", error);
            alert("فشل تصدير البيانات.");
          }
        });

        topicSelector.addEventListener("change", async (event) => {
          const selectedTopicId = event.target.value;
          contentArea.innerHTML = ""; // مسح المحتوى السابق

          if (selectedTopicId) {
            const content = await getTopicContent(selectedTopicId);

            // إنشاء الحاوية الجديدة
            const editorWrapper = document.createElement("div");
            editorWrapper.className = "editor-wrapper";

            // إنشاء طبقة التمييز
            const highlighter = document.createElement("div");
            highlighter.id = "highlighter";

            // إضافة حدث الضغط المزدوج للانتقال للحدث
            highlighter.addEventListener("dblclick", async (e) => {
              if (e.target.classList.contains("date-highlight")) {
                console.log("[تتبع] تم النقر المزدوج على عنصر تاريخ.");
                const dateText = e.target.textContent;
                console.log(
                  `[تتبع] نص التاريخ الذي تم النقر عليه: "${dateText}"`
                );
                try {
                  const event = await findEventByDate(dateText);
                  if (event) {
                    console.log(
                      `[تتبع] تم العثور على الحدث، جاري الانتقال إلى: index.html?eventId=${event.id}`
                    );
                    window.location.href = `index.html?eventId=${event.id}`;
                  } else {
                    alert(`لم يتم العثور على حدث مرتبط بالتاريخ: ${dateText}`);
                  }
                } catch (error) {
                  console.error("Error navigating to event:", error);
                  alert("حدث خطأ أثناء محاولة الانتقال للحدث.");
                }
              }
            });

            // إنشاء منطقة الكتابة
            const textarea = document.createElement("textarea");
            textarea.id = `topic-content-${selectedTopicId}`;
            textarea.placeholder = "اكتب المحتوى الخاص بهذا الموضوع هنا...";
            textarea.value = content;

            // دالة لتحديث التمييز
            const updateHighlight = () => {
              const text = textarea.value;
              // Regex للبحث عن التواريخ بصيغة DD-MM-YYYY مع تحسين للتعامل مع اللغات المختلفة
              const dateRegex = /\b(\d{1,2}-\d{1,2}-\d{4})(?!\d)/g;
              // استبدال التواريخ بعنصر span لتلوينها
              const highlightedText = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(dateRegex, '<span class="date-highlight">$1</span>');

              highlighter.innerHTML = highlightedText + "\n"; // إضافة سطر جديد لضمان تطابق الارتفاع
            };

            textarea.addEventListener("input", (e) => {
              updateHighlight();
              clearTimeout(autoSaveTimer);
              autoSaveTimer = setTimeout(() => {
                saveTopicContent(selectedTopicId, textarea.value);
              }, 500);
            });

            // مزامنة التمرير (scroll)
            textarea.addEventListener("scroll", () => {
              highlighter.scrollTop = textarea.scrollTop;
              highlighter.scrollLeft = textarea.scrollLeft;
            });

            // عند النقر على المحرر، يتم التركيز على منطقة الكتابة وتمكينها
            editorWrapper.addEventListener("click", () => {
              // تمكين الكتابة دائمًا عند النقر على المحرر
              textarea.style.pointerEvents = "auto";
              textarea.focus();
            });

            // عند فقدان التركيز من منطقة الكتابة، يتم تحديث التمييز وإعادة الوضع الافتراضي
            textarea.addEventListener("blur", () => {
              // إعادة تعطيل مؤشر الفأرة للسماح بالضغط المزدوج على التواريخ مرة أخرى
              textarea.style.pointerEvents = "none";
            });
            // تحديث التمييز فقط عند فقدان التركيز بشكل كامل من المحرر
            editorWrapper.addEventListener("focusout", updateHighlight);

            editorWrapper.appendChild(highlighter);
            editorWrapper.appendChild(textarea);
            contentArea.appendChild(editorWrapper);
            textarea.focus();
            updateHighlight(); // تحديث التمييز عند التحميل الأولي
          }
        });

        // حفظ الحالة عند مغادرة الصفحة
        window.addEventListener("pagehide", () => {
          const textarea = document.querySelector(".editor-wrapper textarea");
          if (topicSelector.value) {
            sessionStorage.setItem("selectedTopicId", topicSelector.value);
            if (textarea)
              sessionStorage.setItem("topicScrollTop", textarea.scrollTop);
          }
        });

        function showSaveStatus() {
          saveStatus.textContent = "تم الحفظ تلقائيًا...";
          saveStatus.style.opacity = 1;
          setTimeout(() => {
            saveStatus.style.opacity = 0;
          }, 1500);
        }

        async function initializePage() {
          // إضافة خيار افتراضي
          topicSelector.innerHTML =
            '<option value="">-- اختر موضوعًا --</option>';

          // ملء القائمة المنسدلة من قائمة الكائنات
          topicsList.forEach((topic) => {
            const option = document.createElement("option");
            option.value = topic.id; // استخدام المعرف كقيمة
            option.textContent = topic.name; // استخدام الاسم كعنوان ظاهر
            topicSelector.appendChild(option);
          });

          // تهيئة قاعدة البيانات ببيانات فارغة إذا لزم الأمر
          await initializeEmptyData();

          // استعادة الحالة المحفوظة
          const savedTopicId = sessionStorage.getItem("selectedTopicId");
          if (savedTopicId) {
            topicSelector.value = savedTopicId;
            // تفعيل حدث التغيير لعرض المحتوى
            topicSelector.dispatchEvent(new Event("change"));

            // استعادة موضع التمرير بعد فترة قصيرة لضمان عرض المحتوى
            const savedScrollTop = sessionStorage.getItem("topicScrollTop");
            if (savedScrollTop) {
              setTimeout(() => {
                const textarea = document.querySelector(
                  ".editor-wrapper textarea"
                );
                if (textarea) textarea.scrollTop = parseInt(savedScrollTop, 10);
              }, 200);
            }
          }
        }

        // دالة لتهيئة بيانات فارغة إذا لم يتم العثور على ملف
        async function initializeEmptyData() {
          const db = await openDB();
          const transaction = db.transaction(storeName, "readonly");
          const store = transaction.objectStore(storeName);
          const countRequest = store.count();

          return new Promise((resolve) => {
            countRequest.onsuccess = async () => {
              if (countRequest.result === 0) {
                // قاعدة البيانات فارغة، قم بإنشاء بيانات أولية
                const initialData = topicsList.map((topic) => ({
                  id: topic.id,
                  content: "",
                }));
                await importData(initialData);
                console.log("تم تهيئة قاعدة بيانات الموضوعات ببيانات فارغة.");
                resolve();
              } else {
                // البيانات موجودة بالفعل
                resolve();
              }
            };
          });
        }

        // --- بدء تهيئة الصفحة ---
        initializePage();
      });
    </script>
  </body>
</html>
